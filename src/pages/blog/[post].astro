---
import type { CollectionEntry } from "astro:content";
import { getCollection, render } from "astro:content";
import { giscus } from "spectre:globals";

import type { GetStaticPaths } from "astro";
import Card from "../../components/Card.astro";
import Icon from "../../components/Icon.astro";
import ImageGlow from "../../components/ImageGlow.astro";
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbSeparator,
} from "../../components/ui/breadcrumb";
import Layout from "../../layouts/Layout.astro";

/**
 * Estimates the time it takes to read a post in minutes based on:
 * - A reading speed of 200 words per minute
 * - 10 seconds per image
 * - 20 seconds per code block
 *
 * @param post The post to estimate the reading time for
 */
function timeToRead(post: CollectionEntry<"posts">): number {
  const numWords = (post.body || "")
    .replace(/.*\[(.*?)\].*/gm, "$1")
    .replace(/```.*?```/gms, "")
    .split(/\s+/).length;

  const numImages = post.body?.match(/!\[/g)?.length || 0;
  const numCodeblocks = post.body?.match(/```/g)?.length || 0;

  return Math.ceil(numWords / 300) + Math.ceil(numImages / 6) + Math.ceil(numCodeblocks / 3);
}

interface Props {
  post: CollectionEntry<"posts">;
}

const { post } = Astro.props;

export const getStaticPaths = (async () => {
  const posts = await getCollection("posts", (post) => post.data.draft !== true);

  return posts.map((post) => ({ params: { post: post.id }, props: { post } }));
}) satisfies GetStaticPaths;

// Get all posts and find current post's neighbors
const allPosts = await getCollection("posts", (post) => post.data.draft !== true);
const sortedPosts = allPosts.sort((a, b) => b.data.createdAt.getTime() - a.data.createdAt.getTime());
const currentIndex = sortedPosts.findIndex((p) => p.id === post.id);
// Cycle to oldest post if this is the newest, otherwise go to next newer post
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : sortedPosts[sortedPosts.length - 1];

const { Content, headings } = await render(post);
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  article={{
    createdAt: post.data.createdAt,
    updatedAt: post.data.updatedAt,
  }}
>
  <div class="h-full relative" slot="left">
    <Card class="min-w-0 sticky top-8">
      <Breadcrumb className="mb-2">
        <BreadcrumbList>
          <BreadcrumbItem>
            <BreadcrumbLink href="/" data-pagefind-ignore>Home</BreadcrumbLink>
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbLink href="/blog" data-pagefind-ignore>Blog</BreadcrumbLink>
          </BreadcrumbItem>
        </BreadcrumbList>
      </Breadcrumb>
      <h2 class="mt-0">On this page</h2>
      <ol class="p-0 gap-0.5 flex flex-col mb-0 list-none relative">
        <li>
          <a href={`#_top`} class="text-muted-foreground text-sm py-1 px-2 rounded-sm transition-colors duration-150 hover:text-accent-foreground hover:bg-accent toc-link !no-underline decoration-clone w-fit inline-block">{post.data.title}</a>
        </li>
        {headings.map((heading) => (
          <li class={heading.depth === 3 ? 'ml-4' : heading.depth === 4 ? 'ml-8' : ''} data-depth={heading.depth}>
            <a href={`#${heading.slug}`} class="text-muted-foreground text-sm py-1 px-2 rounded-sm transition-colors duration-150 hover:text-accent-foreground hover:bg-accent toc-link !no-underline decoration-clone w-fit inline-block">{heading.text}</a>
          </li>
        ))}
      </ol>
    </Card>
  </div>
  <article slot="right" data-pagefind-body class="flex flex-col gap-8 leading-relaxed min-w-0 sm:gap-4">
    <Card>
      <div class="relative w-full h-fit" style="scroll-margin-top: 2rem;" id="_top" data-pagefind-ignore>
        <ImageGlow quality={100} class="w-full h-auto z-10" src={post.data.image} alt={post.data.title} />
        <div class="flex flex-col gap-2 absolute bottom-6 left-4 max-w-[calc(100%-3rem)] z-20 sm:relative sm:bottom-0 sm:left-0 sm:w-fit sm:max-w-none sm:mt-4">
          <div>
            <h1 class="mt-0 text-2xl bg-white text-black inline relative leading-tight mb-0 px-3 py-1 sm:inline sm:bg-transparent sm:p-0 sm:text-foreground" style="box-decoration-break: clone; -webkit-box-decoration-break: clone;">{post.data.title}</h1>
          </div>
          <div class="flex flex-row gap-2 bg-accent-foreground text-accent w-fit px-3 sm:block sm:bg-transparent sm:p-0 sm:text-foreground font-mono" style="box-decoration-break: clone; -webkit-box-decoration-break: clone;">
            <span>{post.data.createdAt.toLocaleDateString()}</span>
            <span>/</span>
            <span>{timeToRead(post)} minute{timeToRead(post) === 1 ? "" : "s"} to read</span>
            <span>/</span>
            <span>Tags: {post.data.tags.map((tag) => tag.id).join(", ")}</span>
          </div>
        </div>
      </div>
      <Content />
    </Card>

    <!-- Navigation Section -->
    <nav class="flex items-end justify-between py-6" data-pagefind-ignore>
      <a href="/blog" class="group flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors duration-200 no-underline">
        <Icon type="lucide" name="arrow-left" width={16} height={16} class="transition-transform duration-200 group-hover:-translate-x-1" />
        <div class="flex flex-col">
          <span class="text-xs text-muted-foreground/70">Back</span>
          <span class="line-clamp-1">All posts</span>
        </div>
      </a>

      <a href={`/blog/${nextPost.id}`} class="group flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors duration-200 no-underline text-right">
        <div class="flex flex-col items-end">
          <span class="text-xs text-muted-foreground/70">Next</span>
          <span class="line-clamp-1 max-w-48">{nextPost.data.title}</span>
        </div>
        <Icon type="lucide" name="arrow-right" width={16} height={16} class="transition-transform duration-200 group-hover:translate-x-1" />
      </a>
    </nav>
    {giscus && (
      <Card>
        <div class="comments" data-pagefind-ignore>
          <script
            is:inline
            src="https://giscus.app/client.js"
            data-repo={giscus.repository}
            data-repo-id={giscus.repositoryId}
            data-category={giscus.category}
            data-category-id={giscus.categoryId}
            data-mapping={giscus.mapping}
            data-strict={giscus.strict === true ? "1" : "0"}
            data-reactions-enabled={giscus.reactionsEnabled === true ? "1" : "0"}
            data-emit-metadata={giscus.emitMetadata === true ? "1" : "0"}
            data-input-position={giscus.commentsInput}
            data-theme={`${Astro.url.origin}/styles/giscus`}
            data-lang={giscus.lang}
            data-loading="lazy"
            crossorigin="anonymous"
            async
          />
        </div>
      </Card>
    )}
  </article>
</Layout>
<script src="../../scripts/toc.ts" />
<script src="../../scripts/heading-links.ts" />
<script>
  // Add external link icons and target="_blank" to external links in article content
  document.addEventListener('DOMContentLoaded', () => {
    const article = document.querySelector('article[data-pagefind-body]');
    if (!article) return;

    const links = article.querySelectorAll('a:not([class])');
    links.forEach(link => {
      const href = link.getAttribute('href');
      if (!href) return;

      // Check if it's an external link
      const isExternal = href.startsWith('http://') || href.startsWith('https://');
      const isCurrentDomain = href.includes(window.location.hostname);

      if (isExternal && !isCurrentDomain) {
        link.setAttribute('target', '_blank');
        link.setAttribute('rel', 'noopener noreferrer');
      }
    });
  });

  // Sync Giscus theme with site theme (custom light / custom dark) without reload
  function updateGiscusTheme() {
    const isDark = document.documentElement.classList.contains('dark');
    const theme = isDark ? `${window.location.origin}/styles/giscus-dark` : `${window.location.origin}/styles/giscus`;
    const iframe = document.querySelector('iframe.giscus-frame') as HTMLIFrameElement | null;
    if (!iframe) return false;
    iframe.contentWindow?.postMessage({ giscus: { setConfig: { theme } } }, 'https://giscus.app');
    return true;
  }

  // Try to initialize once Giscus iframe mounts
  function initGiscusThemeSync() {
    let tries = 0;
    const maxTries = 50; // ~5s
    const timer = setInterval(() => {
      if (updateGiscusTheme() || ++tries >= maxTries) clearInterval(timer);
    }, 100);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGiscusThemeSync);
  } else {
    initGiscusThemeSync();
  }

  // React to theme changes
  window.addEventListener('theme-changed', () => {
    // Update immediately if iframe is ready; otherwise retry briefly
    if (!updateGiscusTheme()) {
      let tries = 0;
      const maxTries = 20;
      const timer = setInterval(() => {
        if (updateGiscusTheme() || ++tries >= maxTries) clearInterval(timer);
      }, 100);
    }
  });

  // For client-side navigation
  document.addEventListener('astro:page-load', initGiscusThemeSync);
</script>
